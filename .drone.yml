kind: pipeline
type: docker
name: Unit & Build Test (lowest)

steps:
- name: test
  image: ecmchow/ubuntu-php:focal-7.4
  commands:
  - service redis-server restart
  - chmod -R +x tools
  - tools/php-cs-fixer-v3.phar fix Core --using-cache=no --diff --dry-run --verbose
  - tools/php-cs-fixer-v3.phar fix start-mailer.php --using-cache=no --diff --dry-run --verbose
  - php tools/phpunit-9.5.phar --testsuite core-units
  - openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 -subj "/C=US/ST=Denial/L=Springfield/O=Dis/CN=www.example.com" -keyout test/selfsigned.key -out test/selfsigned.crt
  - bash test/e2e/test-service.sh -u tools/phpunit-9.5.phar -o test/e2e.log -e start-mailer.php && sleep 0.1
  - cat test/e2e.log
  - bash test/e2e/test-redis.sh -u tools/phpunit-9.5.phar -o test/e2e-redis.log -e start-mailer.php && sleep 0.1
  - cat test/e2e-redis.log
  - php tools/box.phar compile
  - chmod +x ./dist/smtp-mailer.phar
  - bash test/e2e/test-service.sh -u tools/phpunit-9.5.phar -o test/build.log -e dist/smtp-mailer.phar -p
  - cat test/build.log
  - bash test/e2e/test-redis.sh -u tools/phpunit-9.5.phar -o test/build-redis.log -e dist/smtp-mailer.phar -p
  - cat test/build-redis.log

trigger:
  event:
  - push
  - pull_request

---
kind: pipeline
type: docker
name: Unit & Build Test (latest)

steps:
- name: test
  image: ecmchow/ubuntu-php:focal-8.1
  commands:
  - service redis-server restart
  - chmod -R +x tools
  - tools/php-cs-fixer-v3.phar fix Core --using-cache=no --diff --dry-run --verbose
  - tools/php-cs-fixer-v3.phar fix start-mailer.php --using-cache=no --diff --dry-run --verbose
  - php tools/phpunit-9.5.phar --testsuite core-units
  - openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 -subj "/C=US/ST=Denial/L=Springfield/O=Dis/CN=www.example.com" -keyout test/selfsigned.key -out test/selfsigned.crt
  - bash test/e2e/test-service.sh -u tools/phpunit-9.5.phar -o test/e2e.log -e start-mailer.php && sleep 0.1
  - cat test/e2e.log
  - bash test/e2e/test-redis.sh -u tools/phpunit-9.5.phar -o test/e2e-redis.log -e start-mailer.php && sleep 0.1
  - cat test/e2e-redis.log
  - php tools/box.phar compile
  - chmod +x ./dist/smtp-mailer.phar
  - bash test/e2e/test-service.sh -u tools/phpunit-9.5.phar -o test/build.log -e dist/smtp-mailer.phar -p
  - cat test/build.log
  - bash test/e2e/test-redis.sh -u tools/phpunit-9.5.phar -o test/build-redis.log -e dist/smtp-mailer.phar -p
  - cat test/build-redis.log

trigger:
  event:
  - push
  - pull_request

---
kind: pipeline
type: docker
name: Test Result

steps:
- name: notify
  image: plugins/slack
  settings:
    webhook:
      from_secret: SLACK_WEBHOOK
  when:
    status:
    - success
    - failure

depends_on:
- Unit & Build Test (lowest)
- Unit & Build Test (latest)

trigger:
  event:
  - push
  - pull_request
  status:  # always run pipeline regardcat of status
  - success
  - failure
